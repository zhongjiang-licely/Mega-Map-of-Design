<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega-Map of Design (MMD)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        #root { min-height: 100vh; }
        .layer-divider { border-top: 1px dashed #d1d5db; }
        .category-card-base {
            height: 110px;
            width: 260px;
            flex-shrink: 0;
            position: relative;
        }
        .grid-5-centered {
            display: grid;
            grid-template-columns: repeat(5, 260px);
            gap: 18px;
            justify-content: center;
        }
        .grid-6-centered {
            display: grid;
            grid-template-columns: repeat(6, 260px);
            gap: 18px;
            justify-content: center;
        }
        .main-container-width {
             max-width: 1700px;
             margin: 0 auto;
             padding: 0 20px;
        }
        .contact-drawer-overlay {
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .contact-drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 500px;
            max-width: 90vw;
            background-color: white;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 51;
        }
        .contact-drawer.is-open { transform: translateX(0); }

        .mmd-rainbow {
            display: inline-block;
            padding-right: 0.1em;
            background: linear-gradient(90deg,
               #deebf7, #bdd7ee, #7eb0de, #4e93d2, #2867A0, #2f5597,
               #203864, #548235, #91c46e, #b3d46a, #c2dd87, #d5e7ad,
               #fff2cc, #ffe699, #ffd653, #eeb500, #d76213, #ef8d4b,
               #f5b88f, #faddca, #ffabab, #e17171, #c04c4c, #b12568,
               #df639e, #e890ba, #f4c8dd, #e3cef2, #b888dc, #9b56ce,
               #7a33af
            );
            background-size: 200%;
            -webkit-background-clip: text;
            color: transparent;
            font-weight: 900;
            font-style: italic;
            animation: rainbow-move 8s linear infinite;
        }
        @keyframes rainbow-move {
            0%   { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        .mmd-gradient {
            display: inline-block;
            padding-right: 0.1em;
            background: linear-gradient(90deg,
                #deebf7, #bdd7ee, #7eb0de, #4e93d2, #2867A0, #2f5597,
                #203864, #91c46e, #b3d46a, #c2dd87, #d5e7ad,
                #fff2cc, #ffe699, #ffd653, #eeb500, #d76213, #ef8d4b,
                #f5b88f, #faddca, #ffabab, #e17171, #c04c4c, #b12568,
                #df639e, #e890ba, #f4c8dd, #e3cef2, #b888dc, #9b56ce,
                #7a33af
            );
           -webkit-background-clip: text;
           color: transparent;
           font-weight: 900;
           font-style: italic;
       }

       .term-panel-wrapper {
            clip-path: inset(0 0 0 100%);
            -webkit-clip-path: inset(0 0 0 100%);
       }
       .term-panel-enter {
            animation: term-panel-reveal 0.3s ease-out forwards;
       }
       .term-panel-exit {
            animation: term-panel-hide 0.3s ease-in forwards;
       }
       @keyframes term-panel-reveal {
            from {
                clip-path: inset(0 0 0 100%);
                -webkit-clip-path: inset(0 0 0 100%);
            }
            to {
                clip-path: inset(0 0 0 0);
                -webkit-clip-path: inset(0 0 0 0);
            }
       }
       @keyframes term-panel-hide {
            from {
                clip-path: inset(0 0 0 0);
                -webkit-clip-path: inset(0 0 0 0);
            }
            to {
                clip-path: inset(0 0 0 100%);
                -webkit-clip-path: inset(0 0 0 100%);
            }
       }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useMemo, useState, useEffect } = React;
        const Papa = window.Papa;

        // 固定数据文件地址（相对 index.html）
        const DATA_URL = "data/mmd.csv";

        const CLASSIC_GRADIENT_PALETTE_31 = [
            "#deebf7", "#bdd7ee", "#7eb0de", "#4e93d2", "#2867A0", "#2f5597",
            "#203864", "#548235", "#91c46e", "#b3d46a", "#c2dd87", "#d5e7ad",
            "#fff2cc", "#ffe699", "#ffd653", "#eeb500", "#d76213", "#ef8d4b",
            "#f5b88f", "#faddca", "#ffabab", "#e17171", "#c04c4c", "#b12568",
            "#df639e", "#e890ba", "#f4c8dd", "#e3cef2", "#b888dc", "#9b56ce",
            "#7a33af",
        ];

        function lightenHex(hex, amount = 20) {
            if (!hex) return hex;
            hex = hex.replace('#', '');
            if (hex.length !== 6) return '#' + hex;

            const num = parseInt(hex, 16);
            let r = (num >> 16) + amount;
            let g = ((num >> 8) & 0x00FF) + amount;
            let b = (num & 0x0000FF) + amount;

            r = Math.min(255, r);
            g = Math.min(255, g);
            b = Math.min(255, b);

            const newHex =
                '#' +
                r.toString(16).padStart(2, '0') +
                g.toString(16).padStart(2, '0') +
                b.toString(16).padStart(2, '0');

            return newHex;
        }

        function getTextColorForBackground(hex) {
          if (!hex) return '#111827';
          const c = hex.replace('#', '');
          if (c.length !== 6) return '#111827';
          const r = parseInt(c.slice(0, 2), 16);
          const g = parseInt(c.slice(2, 4), 16);
          const b = parseInt(c.slice(4, 6), 16);
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;
          return brightness > 175 ? '#111827' : '#FFFFFF';
        }

        function hexToRgba(hex, alpha = 0.4) {
          if (!hex) return `rgba(0,0,0,${alpha})`;
          const c = hex.replace('#', '');
          if (c.length !== 6) return `rgba(0,0,0,${alpha})`;
          const r = parseInt(c.slice(0, 2), 16);
          const g = parseInt(c.slice(2, 4), 16);
          const b = parseInt(c.slice(4, 6), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        const LIST_CATEGORY_HEIGHT = 110;
        const LIST_CATEGORY_ASPECT_RATIO = 2.4;

        function parseCSV(text) {
            if (!Papa) return [];
            const { data, errors } = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: false, encoding: "UTF-8" });
            if (errors.length > 0) { console.error("PapaParse Errors:", errors); }
            return data;
        }

        function normalizeRows(rawRows) {
          const rows = [];
          let lastLayer = "", lastGroup = "", lastCategory = "";
          let lastSubcategory = "", lastTerm = "";

          const getCellValue = (r, key) => {
            const keyLower = key.toLowerCase().replace(/\s/g, '');
            for (const header in r) {
              if (header === null) continue;
              if (String(header).toLowerCase().replace(/\s/g, '') === keyLower) {
                const value = r[header];
                if (value === null || value === undefined || value === "") return "";
                let strValue = String(value);
                strValue = strValue.trim();
                strValue = strValue.replace(/[\u00A0\u200B\t\r\n]+/g, ' ').trim();
                return strValue;
              }
            }
            return "";
          };

          rawRows.forEach(r => {
            const Layer = getCellValue(r, "Layer");
            const Group = getCellValue(r, "Group");
            const Category = getCellValue(r, "Category");
            const Subcategory = getCellValue(r, "Subcategory");
            const Term = getCellValue(r, "Term");
            let Subterm = getCellValue(r, "Subterm");

            if (Layer) lastLayer = Layer;
            if (Group) lastGroup = Group;
            if (Category) lastCategory = Category;
            if (Subcategory) lastSubcategory = Subcategory;
            if (Term) lastTerm = Term;

            // 把只有破折号的 Subterm 视为“空”
            if (Subterm) {
              const onlyDashes = Subterm.replace(/[\s\u00A0\u200B]+/g, '');
              if (/^[-—–]*$/.test(onlyDashes)) {
                Subterm = "";
              }
            }

            if (!lastLayer || !lastGroup || !lastCategory || !lastSubcategory || !lastTerm) {
                console.warn("Skipping row due to missing context (Layer, Group, Category, Subcategory, or Term).");
                return;
            }

            rows.push({
              Layer: lastLayer,
              Group: lastGroup,
              Category: lastCategory,
              Subcategory: lastSubcategory,
              Term: lastTerm,
              Subterm
            });
          });

          return rows;
        }

        function buildStructure(rows) {
          const layers = [];
          let currentLayer = null;
          let currentGroup = "";
          let colorIndex = -1;

          const flatCategories = [];
          let flatIndex = 0;

          rows.forEach((row, idx) => {
            const sub = row.Subcategory;
            const term = row.Term;
            const subterm = row.Subterm;

            if (!currentLayer || row.Layer !== currentLayer.layer) {
              currentLayer = { layer: row.Layer || `Layer ${layers.length + 1}`, groups: [] };
              layers.push(currentLayer);
              currentGroup = "";
            }

            if (row.Group !== currentGroup) {
              currentGroup = row.Group;
              colorIndex = (colorIndex + 1) % CLASSIC_GRADIENT_PALETTE_31.length;
              currentLayer.groups.push({ group: currentGroup, color: CLASSIC_GRADIENT_PALETTE_31[colorIndex], categories: [] });
            }

            const g = currentLayer.groups[currentLayer.groups.length - 1];
            const categoryName = row.Category;
            if (!categoryName) return;

            let cat = g.categories.find((c) => c.name === categoryName);
            if (!cat) {
              const catKey = `${idx}-${categoryName}`;
              cat = { key: catKey, name: categoryName, color: g.color, subs: [], li: layers.length - 1, gi: currentLayer.groups.length - 1, ci: flatIndex };
              g.categories.push(cat);

              flatCategories.push({ ...cat, layer: currentLayer.layer, group: currentGroup });
              flatIndex++;
            }

            if (sub) {
              let sc = cat.subs.find((s) => s.label === sub);
              if (!sc) { sc = { label: sub, color: cat.color, items: [] }; cat.subs.push(sc); }

              if (term) {
                let found = sc.items.find((it) => it.term === term);
                if (!found) { found = { term, subterms: [] }; sc.items.push(found); }

                if (subterm && !found.subterms.includes(subterm)) {
                  found.subterms.push(subterm);
                }
              }
            }
          });

          return { layers, flatCategories };
        }

        function useParsedData(csvText) {
          return useMemo(() => {
            if (!csvText || !csvText.trim().length) {
              return { layers: [], flatCategories: [], count: 0 };
            }
            const raw = parseCSV(csvText);
            const normalized = normalizeRows(raw || []);
            const { layers, flatCategories } = buildStructure(normalized);
            const catCount = flatCategories.length;
            return { layers, flatCategories, count: catCount };
          }, [csvText]);
        }

        function getFixedPositionsRect(centerW, centerH) {
          const subH = Math.round(centerH * 0.68);
          const subW = Math.round(centerW * 0.68);

          const maxSlots = 13;
          const positions = [];

          const margin = 24;

          const baseRadiusX = centerW / 2 + subW / 2 + margin;
          const baseRadiusY = centerH / 2 + subH / 2 + margin;

          const radiusScaleX = 1.5;
          const radiusScaleY = 2.0;

          const radiusX = baseRadiusX * radiusScaleX;
          const radiusY = baseRadiusY * radiusScaleY;

          const step = (2 * Math.PI) / maxSlots;
          const offsetFactor = 0.37;
          const angleOffset = step * offsetFactor;

          for (let i = 0; i < maxSlots; i++) {
            const angle = -Math.PI / 2 + angleOffset + step * i;
            const x = Math.round(Math.cos(angle) * radiusX);
            const y = Math.round(Math.sin(angle) * radiusY);
            positions.push({ x, y });
          }

          return { positions, subW, subH };
        }

        const ContactDrawer = ({ isOpen, onClose }) => {
            return (
                <div
                    className={`fixed inset-0 contact-drawer-overlay transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                    onClick={onClose}
                >
                    <div
                        className={`contact-drawer ${isOpen ? 'is-open' : ''} flex flex-col`}
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex-shrink-0 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-slate-900">Contact Us</h2>
                            <button
                                onClick={onClose}
                                className="text-slate-500 hover:text-slate-900 text-3xl leading-none"
                            >
                                &times;
                            </button>
                        </div>

                        <div className="flex-grow overflow-y-auto p-6 text-slate-800">
                            <div className="space-y-4 text-base">
                                <h3 className="text-xl font-bold mb-3">Contribute to the MMD</h3>

                                <p>
                                    <strong>The Mega-Map of Design (MMD)</strong> aims to serve as a foundational knowledge
                                    infrastructure for the design field by presenting an ever-evolving panoramic
                                    map of contemporary design research. To keep the MMD accurate, comprehensive,
                                    and up to date, we warmly invite researchers from around the world to contribute
                                    to its ongoing development.
                                </p>

                                <h3 className="font-semibold text-lg pt-2">We encourage every researcher to support the MMD in the following ways:</h3>

                                <p>
                                    <strong>Report inaccuracies:</strong><br />
                                    If you notice any errors, inconsistencies, or questionable information while
                                    browsing the MMD, please contact the management team so that corrections can be
                                    made promptly.
                                </p>

                                <p>
                                    <strong>Suggest missing areas:</strong><br />
                                    If your own area of expertise, especially new or emerging domains, has not yet
                                    been included in the MMD, please reach out to recommend its inclusion.
                                </p>

                                <p className="pt-2">
                                    You may <strong>contact the management team via email</strong> at:<br />
                                    <code className="bg-slate-100 p-1 rounded font-mono text-base inline-block mt-1">
                                        xxxxxxxxxxxx@xxxxxx
                                    </code>
                                    <br />
                                    <span className="text-sm text-slate-500 italic">
                                        (The email addresses above are currently replaced with placeholders to
                                        facilitate double-blind peer review. They will be restored after the review
                                        process is completed.)
                                    </span>
                                </p>

                                <p className="pt-2">
                                    When submitting suggestions, please clearly indicate the content you believe
                                    should be corrected or added, and <strong>provide supporting literature</strong> to help
                                    the management team assess the reliability of your contribution as efficiently
                                    as possible.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        function DesignMapPage() {
          const [csvText, setCsvText] = useState("");
          const { flatCategories, count } = useParsedData(csvText);
          const [active, setActive] = useState(null);
          const [detailIdx, setDetailIdx] = useState(null);
          const [isContactOpen, setIsContactOpen] = useState(false);
          const [vh, setVh] = useState(800);
          const [visibleCardCount, setVisibleCardCount] = useState(0);
          const [isPanelClosing, setIsPanelClosing] = useState(false);
          const [isDetailLayoutActive, setIsDetailLayoutActive] = useState(false);

          // 页面加载时自动拉取 CSV
          useEffect(() => {
            fetch(DATA_URL)
              .then(res => {
                if (!res.ok) throw new Error("Failed to load data file");
                return res.text();
              })
              .then(text => {
                setCsvText(text);
              })
              .catch(err => {
                console.error("Error loading CSV:", err);
              });
          }, []);

          useEffect(() => {
            const update = () => setVh(window.innerHeight || 800);
            update();
            window.addEventListener("resize", update);
            return () => window.removeEventListener("resize", update);
          }, []);

          useEffect(() => {
              setVisibleCardCount(0);
              if (flatCategories.length > 0) {
                  let currentCount = 0;
                  const interval = setInterval(() => {
                      currentCount++;
                      setVisibleCardCount(c => c + 1);
                      if (currentCount >= flatCategories.length) {
                          clearInterval(interval);
                      }
                  }, 100);

                  return () => clearInterval(interval);
              }
          }, [flatCategories.length]);

          useEffect(() => {
            if (active || isContactOpen) {
              document.body.style.overflow = 'hidden';
            } else {
              document.body.style.overflow = '';
            }
            return () => {
              document.body.style.overflow = '';
            };
          }, [active, isContactOpen]);

          const openCategory = (li, gi, ci) => {
            setActive({ li, gi, ci });
            setDetailIdx(null);
            setIsPanelClosing(false);
            setIsDetailLayoutActive(false);
          };

          const closeOverlay = () => {
            setActive(null);
            setDetailIdx(null);
            setIsPanelClosing(false);
            setIsDetailLayoutActive(false);
          };

          const closeTermPanelWithAnimation = () => {
            if (detailIdx === null) return;
            setIsDetailLayoutActive(false);
            setIsPanelClosing(true);
            setTimeout(() => {
              setDetailIdx(null);
              setIsPanelClosing(false);
            }, 300);
          };

          const handleOverlayClick = () => {
            if (detailIdx !== null) {
              closeTermPanelWithAnimation();
            } else {
              closeOverlay();
            }
          };

          useEffect(() => {
            const handleKey = (e) => {
              if (e.key === 'Escape') {
                if (active && detailIdx !== null) {
                  e.preventDefault();
                  closeTermPanelWithAnimation();
                } else if (active) {
                  e.preventDefault();
                  closeOverlay();
                } else if (isContactOpen) {
                  e.preventDefault();
                  setIsContactOpen(false);
                }
              }
            };
            window.addEventListener('keydown', handleKey);
            return () => window.removeEventListener('keydown', handleKey);
          }, [active, detailIdx, isContactOpen]);

          const CategoryCard = ({ c, ci, globalIndex, isVisible }) => {
              const textColor = getTextColorForBackground(c.color);

              return (
                <button
                    onClick={() => openCategory(c.li, c.gi, ci)}
                    className={`w-full text-left transition-opacity duration-300 ${isVisible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                    aria-label={`open ${c.name} overlay`}
                >
                    <div
                        className="category-card-base rounded-2xl px-4 py-3 shadow-xl ring-1 ring-black/10 transition hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-white flex items-center justify-center text-center"
                        style={{ background: c.color, color: textColor }}
                        title={`Group: ${c.group} / Category: ${c.name}`}
                    >
                        <div className="text-lg font-semibold leading-snug break-words line-clamp-3">
                            {c.name}
                        </div>
                    </div>
                </button>
              );
          };

          const EmptyCard = ({ key }) => (
              <div
                  key={key}
                  className="category-card-base rounded-2xl p-4 transition"
                  style={{ opacity: 0 }}
              />
          );

          const renderPage1 = () => {
            const categorizedData = [];
            let currentLayer = null;
            let globalCatIndex = 0;

            flatCategories.forEach((cat) => {
                const isNewLayer = cat.layer !== currentLayer;
                if (isNewLayer) {
                    categorizedData.push({ type: 'layer_start', layer: cat.layer });
                    currentLayer = cat.layer;
                }
                categorizedData.push({ type: 'category', data: cat, globalIndex: globalCatIndex });
                globalCatIndex++;
            });

            const renderBlocks = [];
            let rowBuffer = [];
            let isOddRow = true;
            let rowCount = 0;
            let currentLayerForRows = null;

            const getRowSize = (odd, layerName) => {
              if (layerName === 'Layer 3') {
                return odd ? 6 : 5;
              }
              return odd ? 5 : 6;
            };

            const pushAndResetRow = (buffer, odd, blocks, count, layerName) => {
                const rowSize = getRowSize(odd, layerName);
                while (buffer.length < rowSize) {
                    buffer.push({ type: 'empty', key: `empty-${count}-${buffer.length}` });
                }
                blocks.push({ type: 'row', data: buffer, isOddRow: odd, layer: layerName });
                return { newBuffer: [], newOdd: !odd, newCount: count + 1 };
            };

            categorizedData.forEach(item => {
                if (item.type === 'layer_start') {
                    if (rowBuffer.length > 0 && currentLayerForRows) {
                        const { newBuffer, newOdd, newCount } = pushAndResetRow(
                            rowBuffer,
                            isOddRow,
                            renderBlocks,
                            rowCount,
                            currentLayerForRows
                        );
                        rowBuffer = newBuffer;
                        isOddRow = newOdd;
                        rowCount = newCount;
                    }

                    renderBlocks.push({ type: 'layer_divider', layer: item.layer });

                    rowBuffer = [];
                    isOddRow = true;
                    currentLayerForRows = item.layer;
                } else if (item.type === 'category') {
                    const rowSize = getRowSize(isOddRow, currentLayerForRows);
                    rowBuffer.push(item);

                    if (rowBuffer.length === rowSize) {
                        const { newBuffer, newOdd, newCount } = pushAndResetRow(
                            rowBuffer,
                            isOddRow,
                            renderBlocks,
                            rowCount,
                            currentLayerForRows
                        );
                        rowBuffer = newBuffer;
                        isOddRow = newOdd;
                        rowCount = newCount;
                    }
                }
            });

            if (rowBuffer.length > 0 && currentLayerForRows) {
                pushAndResetRow(rowBuffer, isOddRow, renderBlocks, rowCount, currentLayerForRows);
            }

            return (
                <div className="main-container-width">
                    {renderBlocks.map((block, index) => {
                        if (block.type === 'layer_divider') {
                            const showDivider = index > 0;
                            return (
                                <div key={`layer-${index}`} className={`relative my-12 ${index === 0 ? 'mt-0' : 'pt-6'}`}>
                                    <div className={`absolute top-0 left-0 w-full layer-divider ${!showDivider ? 'hidden' : ''}`} />
                                </div>
                            );
                        } else if (block.type === 'row') {
                            const isOddRow = block.isOddRow;
                            const rowData = block.data;
                            const isLayer3 = block.layer === 'Layer 3';

                            const useGrid6 = isLayer3 ? isOddRow : !isOddRow;
                            const gridClass = useGrid6 ? 'grid-6-centered' : 'grid-5-centered';

                            const shouldReverse = !isOddRow;
                            const itemsToRender = shouldReverse ? rowData.slice().reverse() : rowData;

                            return (
                                <div key={`row-${index}`} className={`w-full mb-6 ${gridClass}`}>
                                    {itemsToRender.map((item) => (
                                        item.type === 'category' ? (
                                            <CategoryCard
                                                key={item.data.key}
                                                c={item.data}
                                                ci={item.data.ci}
                                                globalIndex={item.globalIndex}
                                                isVisible={item.globalIndex < visibleCardCount}
                                            />
                                        ) : (
                                            <EmptyCard key={item.key} />
                                        )
                                    ))}
                                </div>
                            );
                        }
                        return null;
                    })}
                </div>
            );
          };

          return (
            <div className="min-h-screen w-full bg-white text-slate-800">

              <div className="sticky top-0 z-20 bg-white/95 backdrop-blur-sm border-b border-slate-100">
                <div className="main-container-width pt-10 pb-4 flex flex-col items-center">

                  <div className="absolute top-8 left-6">
                      <span className="mmd-gradient text-2xl">
                          MMD
                      </span>
                  </div>

                  <div className="absolute top-8 right-6">
                      <button
                          onClick={() => setIsContactOpen(true)}
                          className="text-base font-medium border border-slate-300 px-5 py-2 rounded-xl text-slate-700 hover:bg-slate-50 transition"
                      >
                          Contact Us
                      </button>
                  </div>

                  <h1 className="text-4xl font-extrabold text-slate-900 mb-8">
                    Mega-Map of Design
                  </h1>
                </div>
              </div>

              <ContactDrawer
                  isOpen={isContactOpen}
                  onClose={() => setIsContactOpen(false)}
              />

              {renderPage1()}

              {active && (() => {
                  const C = flatCategories[active.ci];
                  if (!C) return null;

                  const subs = C.subs || [];
                  const CENTER_H = LIST_CATEGORY_HEIGHT + 30;
                  const CENTER_W = Math.round(CENTER_H * LIST_CATEGORY_ASPECT_RATIO);
                  const ellipseShiftX = isDetailLayoutActive ? -160 : 0;
                  const centerShiftX = isDetailLayoutActive ? -160 : 0;

                  const { positions: POS, subW, subH } = getFixedPositionsRect(CENTER_W, CENTER_H);

                  const maxSlots = POS.length;
                  const usedCount = Math.min(subs.length, maxSlots);
                  let ringOrder = [];
                  if (maxSlots > 0) {
                    let maxX = -Infinity;
                    for (let i = 0; i < maxSlots; i++) {
                      if (POS[i].x > maxX) maxX = POS[i].x;
                    }
                    const indexed = POS.map((p, idx) => ({ idx, x: p.x, y: p.y }));
                    indexed.sort((a, b) => {
                      const da = Math.abs(a.x - maxX);
                      const db = Math.abs(b.x - maxX);
                      if (da !== db) return da - db;
                      if (a.y !== b.y) return a.y - b.y;
                      return a.idx - b.idx;
                    });
                    ringOrder = indexed.map(p => p.idx);
                  }
                  const usedIndices = ringOrder.slice(0, usedCount);

                  const centerTextColor = getTextColorForBackground(C.color);

                  return (
                    <div
                      className="fixed inset-0 z-30 bg-slate-900/70 backdrop-blur-sm"
                      onClick={handleOverlayClick}
                    >
                      <div className="flex items-center justify-center w-full h-full p-6">
                        <div
                          className="relative w-full max-w-7xl"
                          style={{ height: Math.round(vh * 0.8) }}
                        >
                          <div className="w-full h-full flex gap-6">

                            <div className="w-[65%] h-full relative">
                              <div className="absolute inset-0">

                                <div
                                  className="absolute rounded-3xl shadow-2xl ring-2 ring-white/70 flex items-center justify-center text-center p-4 cursor-default transition-all duration-300 ease-out"
                                  style={{
                                    width: CENTER_W,
                                    height: CENTER_H,
                                    left: `calc(50% + ${centerShiftX}px)`,
                                    top: '50%',
                                    transform: `translate(-50%, -50%)`,
                                    background: C.color,
                                    color: centerTextColor,
                                    userSelect: 'text'
                                  }}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                  }}
                                >
                                  <div className="text-xl font-semibold leading-tight break-words max-w-[14rem]">
                                    {C.name}
                                  </div>
                                </div>

                                {Array.from({ length: usedCount }).map((_, idx) => {
                                  const sub = subs[idx];
                                  const posIndex = usedIndices[idx];
                                  const p = POS[posIndex];

                                  const isSelected = detailIdx === idx;
                                  const isActive = (isDetailLayoutActive || isPanelClosing) && isSelected;

                                  const subBg = lightenHex(C.color, 50);
                                  const subTextColor = getTextColorForBackground(subBg);
                                  const borderWidth = isActive ? 6 : 3;
                                  const subBoxShadow = `0 0 0 ${borderWidth}px rgba(255,255,255,0.7), 0 8px 22px rgba(15,23,42,0.35)`;

                                  return (
                                    <button
                                      key={idx}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        if (detailIdx === null) {
                                          setDetailIdx(idx);
                                          setIsPanelClosing(false);
                                          setIsDetailLayoutActive(true);
                                        } else if (detailIdx !== idx) {
                                          setDetailIdx(idx);
                                          setIsPanelClosing(false);
                                          setIsDetailLayoutActive(true);
                                        }
                                      }}
                                      className="absolute rounded-xl shadow-lg ring-1 ring-black/10 text-center flex items-center justify-center transition-all duration-300 ease-out"
                                      style={{
                                        width: subW,
                                        height: subH,
                                        left: `calc(50% + ${p.x + ellipseShiftX}px)`,
                                        top: `calc(50% + ${p.y}px)`,
                                        transform: 'translate(-50%, -50%)',
                                        background: subBg,
                                        color: subTextColor,
                                        boxShadow: subBoxShadow,
                                        opacity:
                                          (isDetailLayoutActive || isPanelClosing) && detailIdx !== null && !isSelected
                                            ? 0.4
                                            : 1,
                                        userSelect: 'text',
                                        cursor: isSelected ? 'default' : 'pointer',
                                        zIndex: isActive ? 30 : 10
                                      }}
                                    >
                                      <div className="font-medium leading-tight break-words px-3 py-2 text-base">
                                        {sub?.label || "Subcategory"}
                                      </div>
                                    </button>
                                  );
                                })}
                              </div>
                            </div>

                            <div className="w-[35%] h-full flex items-center justify-end">
                              {detailIdx !== null && (() => {
                                const s = subs[detailIdx] || { label: 'No Subcategory', items: [] };
                                const items = s.items;

                                const panelBg = lightenHex(C.color, 50);
                                const panelTextColor = getTextColorForBackground(panelBg);
                                const panelBoxShadow = '0 0 0 6px rgba(255,255,255,0.7), 0 8px 22px rgba(15,23,42,0.35)';

                                return (
                                  <div
                                     key={detailIdx}
                                     className={`term-panel-wrapper ${isPanelClosing ? 'term-panel-exit' : 'term-panel-enter'}`}
                                     style={{ height: '90%', width: '100%', padding: '6px', boxSizing: 'border-box' }}
                                     onClick={(e) => e.stopPropagation()}
                                  >
                                    <div
                                      className="rounded-3xl w-full h-full overflow-hidden transition-all ease-out shadow-lg ring-1 ring-black/10"
                                      style={{
                                          background: panelBg,
                                          color: panelTextColor,
                                          userSelect: 'text',
                                          boxShadow: panelBoxShadow,
                                      }}
                                    >
                                      {/* 标题 + 横线 */}
                                      <div
                                        className="px-6 pt-4 pb-3"
                                        style={{
                                               borderBottom: `1px solid ${hexToRgba(panelTextColor, 0.4)}`
                                        }}
                                      >
                                        <div
                                            className="text-xl font-bold truncate pr-4"
                                            style={{ color: panelTextColor }}
                                        >
                                            {s.label || 'Subcategory Detail'}
                                        </div>
                                      </div>

                                      {/* 内容区域 */}
                                      <div className="px-6 py-5 overflow-y-auto h-full pb-10">
                                        {items.length > 0 ? (
                                          items.map((it, i) => (
                                            <div
                                              key={i}
                                              className="mb-4 pb-3"
                                              style={{
                                                      borderBottom: `1px solid ${hexToRgba(panelTextColor, 0.3)}`
                                              }}
                                            >
                                              {it.term && (
                                                <div className="text-lg font-medium mb-1">
                                                  {it.term}
                                                </div>
                                              )}

                                              {it.subterms && it.subterms.length ? (
                                                <ul className="mt-2 text-base opacity-95 list-none space-y-1">
                                                  {it.subterms.map((sub, j) => (
                                                    <li key={j} className="flex">
                                                      <span className="mr-2 flex-shrink-0">–</span>
                                                      <span>{sub}</span>
                                                    </li>
                                                  ))}
                                                </ul>
                                              ) : null}
                                            </div>
                                          ))
                                        ) : (
                                          <div className="text-center text-base opacity-80 pt-10">
                                              此 Subcategory 暂无 Term 或 Subterm 数据。
                                          </div>
                                        )}
                                        <div className="h-10" />
                                      </div>
                                    </div>
                                  </div>
                                );
                              })()}
                            </div>

                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })()}

              <div className="fixed bottom-4 left-4 sm:block">
                <div className="rounded-full bg-slate-900 text-white/90 text-sm px-4 py-2 shadow-lg shadow-black/20">
                  {`Categories: ${count} · Groups: ${CLASSIC_GRADIENT_PALETTE_31.length} Colors Used`}
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<DesignMapPage />);
    </script>
</body>
</html>
